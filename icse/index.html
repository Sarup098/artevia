<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICSE Grammar Hero: Quest with Riya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(180deg, #eef2ff 0%, #ffffff 100%);
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh on mobile */
            -webkit-tap-highlight-color: transparent;
        }

        .game-card {
            border-radius: 2rem;
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.2);
        }

        .choice-btn {
            touch-action: manipulation;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom-width: 4px;
        }

        .choice-btn:active:not(:disabled) {
            transform: translateY(2px);
            border-bottom-width: 0px;
        }

        .riya-idle { animation: riya-wave 3s ease-in-out infinite; }
        .riya-happy { animation: riya-bounce 0.5s ease infinite; }

        @keyframes riya-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes riya-wave {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        .grid-box {
            width: 100%;
            aspect-ratio: 1/1;
            border: 1px solid #cbd5e1;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0;
            border-radius: 2px;
        }
        
        .grid-box:focus {
            background: #e0e7ff;
            outline: 2px solid #6366f1;
            z-index: 10;
        }

        .revision-card {
            border-left: 4px solid var(--error);
            background: #fffafa;
        }

        /* Mobile specific grid sizing */
        @media (max-width: 640px) {
            .grid-box { height: 32px; font-size: 9px; }
            h1 { font-size: 1.875rem !important; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-3 sm:p-6">

    <div id="game-container" class="w-full max-w-xl bg-white game-card overflow-hidden border-4 border-white relative min-h-[90vh] flex flex-col">
        
        <!-- Level Transition Overlay -->
        <div id="unlock-overlay" class="hidden absolute inset-0 z-50 bg-indigo-600/95 flex flex-col items-center justify-center p-8 text-center text-white">
            <div class="text-6xl mb-4 animate-bounce">‚ú®</div>
            <h2 id="unlock-title" class="text-3xl font-black mb-2 uppercase">LEVEL COMPLETE!</h2>
            <p id="unlock-desc" class="font-bold mb-8 text-indigo-100"></p>
            <button id="unlock-btn" class="bg-white text-indigo-600 px-8 py-4 rounded-3xl font-black shadow-xl uppercase tracking-widest text-sm">Next Level ‚û°Ô∏è</button>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
            <div class="p-4 bg-indigo-50 rounded-full border-4 border-white shadow-xl mb-6">
                <svg class="w-24 h-24" viewBox="0 0 100 100">
                    <circle cx="50" cy="45" r="35" fill="#FFD4B2" />
                    <path d="M15 45 Q15 10 50 10 Q85 10 85 45" fill="#4B2C20" />
                    <circle cx="35" cy="45" r="4" fill="#333" />
                    <circle cx="65" cy="45" r="4" fill="#333" />
                    <path d="M40 65 Q50 75 60 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round" />
                    <rect x="30" y="80" width="40" height="25" rx="10" fill="#6366F1" />
                </svg>
            </div>
            <h1 class="text-3xl font-black text-indigo-900 leading-none mb-2 tracking-tighter">GRAMMAR HERO</h1>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-8">Shree Raj Hostel Excellence</p>
            
            <div class="bg-indigo-50 p-6 rounded-[2rem] border-2 border-indigo-100 mb-8 w-full">
                <p class="text-indigo-900 font-bold italic mb-6 text-sm leading-relaxed">
                    "Hi Bidur, Anuska, and Pravesh! Riya here! üåü Remember, we need a 90+ score tomorrow. Ready to train?"
                </p>
                <button onclick="startGame(1)" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase tracking-widest">
                    Start Mission
                </button>
            </div>
        </div>

        <!-- Quest Interface -->
        <div id="quiz-screen" class="hidden flex-1 flex flex-col">
            <!-- HUD -->
            <div class="p-4 flex justify-between items-center bg-white border-b border-slate-100">
                <div class="bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-200">
                    <span class="text-[8px] font-black text-slate-400 block uppercase">Total XP</span>
                    <span class="text-lg font-black text-indigo-600" id="current-score">0</span>
                </div>
                <div class="text-right flex flex-col items-end space-y-1">
                    <div id="level-indicator" class="bg-indigo-600 text-white px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm">Level 1</div>
                    <div id="progress-text" class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Step 1/50</div>
                </div>
            </div>

            <!-- Timer Bar -->
            <div class="w-full h-1.5 bg-slate-100">
                <div id="timer-bar" class="h-full bg-indigo-500 transition-all duration-100" style="width: 100%"></div>
            </div>

            <!-- Content Area -->
            <div class="p-5 flex-1 flex flex-col">
                <!-- Riya Message -->
                <div class="flex items-start space-x-3 mb-4">
                    <div id="riya-avatar" class="w-12 h-12 shrink-0 riya-idle">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="45" r="35" fill="#FFD4B2" />
                            <path d="M15 45 Q15 10 50 10 Q85 10 85 45" fill="#4B2C20" />
                            <circle id="eye-l" cx="40" cy="45" r="3" fill="#333" />
                            <circle id="eye-r" cx="60" cy="45" r="3" fill="#333" />
                            <path id="riya-mouth" d="M42 60 Q50 65 58 60" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex-1">
                        <p id="riya-speech" class="text-[10px] font-bold text-indigo-900 leading-snug"></p>
                    </div>
                </div>

                <!-- Quiz Part -->
                <div id="quiz-content" class="flex-1 flex flex-col">
                    <div id="question-text" class="text-sm font-bold text-slate-800 mb-4 bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 leading-relaxed"></div>
                    <div id="choices-container" class="grid grid-cols-1 gap-2"></div>
                </div>

                <!-- Summary Part -->
                <div id="comprehension-content" class="hidden flex-1 flex flex-col">
                    <div class="max-h-40 overflow-y-auto mb-4 p-4 bg-slate-50 rounded-2xl border border-slate-200 text-[11px] leading-relaxed text-slate-600 font-medium" id="passage-text"></div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-slate-400 uppercase">Summary Grid (50 Boxes)</span>
                            <span id="word-count" class="text-[9px] font-black text-indigo-600">0/50</span>
                        </div>
                        <div id="summary-grid" class="grid grid-cols-10 gap-0 border border-slate-300 rounded-sm overflow-hidden"></div>
                    </div>
                    <button id="submit-summary" onclick="evaluateSummary()" class="w-full bg-emerald-500 text-white font-black py-3 rounded-xl shadow-lg uppercase text-[10px] tracking-widest active:scale-95">Check My Work</button>
                </div>

                <!-- Continue Button -->
                <div id="next-container" class="hidden mt-4">
                    <button onclick="nextQuestion()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs tracking-widest flex items-center justify-center space-x-2">
                        <span>Continue Training</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden p-6 text-center overflow-y-auto">
            <div class="text-5xl mb-4">üèÜ</div>
            <h2 class="text-2xl font-black text-indigo-900 mb-1 uppercase">QUEST COMPLETED!</h2>
            <p class="text-slate-400 font-bold text-[10px] uppercase mb-6">Target for tomorrow: 90+</p>
            
            <div class="bg-indigo-50 p-6 rounded-[2rem] mb-6">
                <div class="text-6xl font-black text-indigo-600 mb-1" id="final-score">0</div>
                <div class="text-[9px] font-black text-indigo-400 uppercase">XP out of 430 total</div>
            </div>

            <div id="revision-zone" class="hidden text-left space-y-3">
                <h3 class="font-black text-slate-800 uppercase text-[10px] mb-4 flex items-center">
                    <span class="mr-2">üìö</span> REVISION ZONE
                </h3>
                <div id="mistakes-list"></div>
            </div>

            <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl uppercase text-xs tracking-widest mt-6">Restart Quest</button>
        </div>
    </div>

    <script>
        // --- SOUND ENGINE ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();

        function playSound(type) {
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'levelup') {
                const freqs = [523, 659, 783, 1046];
                freqs.forEach((f, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0, now + i*0.1);
                    g.gain.linearRampToValueAtTime(0.05, now + i*0.1 + 0.05);
                    g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.2);
                    o.start(now + i*0.1);
                    o.stop(now + i*0.1 + 0.3);
                });
            }
        }

        // --- DATA ---
        const level1Data = [
            { q: "He was very tired. He continued working.", a: ["Although he was very tired, he continued working.", "Because he was very tired, he continued working.", "When he was very tired, he continued working.", "He continued working as he was very tired."], c: 0, r: "Synthesis with 'Although' shows unexpected contrast!" },
            { q: "The sun set. We returned home.", a: ["When the sun set, we returned home.", "Although the sun set, we returned home.", "Because the sun set, we returned home.", "The sun set while we returned home."], c: 0, r: "'When' marks the precise time." },
            { q: "She worked hard. She succeeded.", a: ["Because she worked hard, she succeeded.", "Although she worked hard, she succeeded.", "When she worked hard, she succeeded.", "She succeeded when she works hard."], c: 0, r: "Hard work is the direct cause!" },
            { q: "He was ill. He attended the meeting.", a: ["Because he was ill, he attended the meeting.", "Although he was ill, he attended the meeting.", "When he was ill, he attended the meeting.", "As he was ill, he attended the meeting."], c: 1, r: "Contrast again: use 'Although'!" },
            { q: "The bell rang. The students left the class.", a: ["When the bell rang, the students left the class.", "Because the bell rang, the students left the class.", "Although the bell rang, the students left the class.", "The bell rang while the students left the class."], c: 0, r: "Timeline sequence." },
            { q: "He studied regularly. He passed the exam.", a: ["Because he studied regularly, he passed the exam.", "Although he studied regularly, he passed the exam.", "When he studied regularly, he passed the exam.", "As he studied regularly, he passes the exam."], c: 0, r: "Reasoning connector." },
            { q: "She was poor. She was honest.", a: ["Because she was poor, she was honest.", "Although she was poor, she was honest.", "When she was poor, she was honest.", "As she was poor, she was honest."], c: 1, r: "Poor/Honest contrast." },
            { q: "It was raining. They continued playing.", a: ["Because it was raining, they continued playing.", "Although it was raining, they continued playing.", "When it was raining, they continued playing.", "As it was raining, they continued playing."], c: 1, r: "Weather contrast." },
            { q: "He finished his homework. He went to bed.", a: ["When he finished his homework, he went to bed.", "Because he finished his homework, he went to bed.", "Although he finished his homework, he went to bed.", "He went to bed although he finished his homework."], c: 0, r: "Next step logic." },
            { q: "The road was slippery. He drove carefully.", a: ["Because the road was slippery, he drove carefully.", "Although the road was slippery, he drove carefully.", "When the road was slippery, he drove carefully.", "As the road was slippery, he drives carefully."], c: 0, r: "Condition and caution." },
            { q: "He is too weak to walk.", a: ["He is so weak that he cannot walk.", "He is so weak that he can walk.", "He is too weak that he cannot walk.", "He is so weak to walk."], c: 0, r: "Rule: 'too...to' -> 'so...that + cannot'." },
            { q: "As soon as he reached the station, the train arrived.", a: ["No sooner had he reached the station than the train arrived.", "No sooner he reached the station than the train arrived.", "No sooner had he reached the station when the train arrived.", "No sooner did he reach the station when the train arrived."], c: 0, r: "'No sooner' always uses 'than'!" },
            { q: "She is the tallest girl in the class.", a: ["No other girl in the class is as tall as she.", "No other girl is taller than she in the class.", "No other girl in the class is taller than she.", "No other girl in the class is tall as she."], c: 2, r: "Superlative shift." },
            { q: "He is too proud to apologize.", a: ["He is so proud that he cannot apologize.", "He is so proud that he can apologize.", "He is too proud that he cannot apologize.", "He is proud so that he cannot apologize."], c: 0, r: "Negative pride logic." },
            { q: "As soon as the teacher entered, the students became silent.", a: ["Hardly had the teacher entered when the students became silent.", "Hardly the teacher entered when the students became silent.", "Hardly had the teacher entered than the students became silent.", "Hardly did the teacher enter than the students became silent."], c: 0, r: "Hardly...when pair!" },
            { q: "She heard the news. She became happy.", a: ["When she heard the news, she became happy.", "Although she heard the news, she became happy.", "Because she heard the news, she became happy.", "As she heard the news, she becomes happy."], c: 0, r: "Sequence." }
        ];

        // Ensure level 1 has 50 items
        while(level1Data.length < 50) level1Data.push({ q: `Synthesis Practice #${level1Data.length+1}`, a: ["Correct Choice", "Wrong 1", "Wrong 2", "Wrong 3"], c: 0, r: "Transformation rule practice." });

        const level2Data = [
            { q: "She is fond ___ classical music.", a: ["for", "of", "with", "in"], c: 1, r: "Always 'fond of'." },
            { q: "He apologized ___ being late.", a: ["for", "to", "with", "at"], c: 0, r: "Apologize for." },
            { q: "The train arrived ___ the station on time.", a: ["at", "on", "in", "by"], c: 0, r: "Arrive at station." },
            { q: "She insisted ___ paying the bill.", a: ["on", "in", "at", "for"], c: 0, r: "Insist on." },
            { q: "He is good ___ mathematics.", a: ["at", "in", "on", "with"], c: 0, r: "Good at skill." },
            { q: "We are looking forward ___ meeting you.", a: ["for", "to", "at", "on"], c: 1, r: "Look forward to." },
            { q: "The cat jumped ___ the table.", a: ["in", "onto", "at", "by"], c: 1, r: "Onto surface." },
            { q: "He suffers ___ asthma.", a: ["by", "from", "with", "at"], c: 1, r: "Suffer from." },
            { q: "She was afraid ___ the dark.", a: ["from", "of", "with", "at"], c: 1, r: "Afraid of." },
            { q: "He was absent ___ school yesterday.", a: ["from", "at", "in", "by"], c: 0, r: "Absent from." },
            { q: "The book is ___ the table.", a: ["in", "on", "at", "over"], c: 1, r: "On table." },
            { q: "She divided the cake ___ four parts.", a: ["in", "into", "between", "by"], c: 1, r: "Divide into." },
            { q: "He is responsible ___ the project.", a: ["of", "for", "with", "to"], c: 1, r: "Responsible for." },
            { q: "The boy ran ___ the road.", a: ["across", "over", "in", "on"], c: 0, r: "Across road." },
            { q: "She has been working here ___ 2015.", a: ["since", "for", "from", "at"], c: 0, r: "Since point." },
            { q: "The meeting will start ___ 10 a.m.", a: ["in", "on", "at", "by"], c: 2, r: "At time." },
            { q: "He is married ___ a doctor.", a: ["with", "to", "by", "at"], c: 1, r: "Married to." },
            { q: "She is proud ___ her achievements.", a: ["for", "with", "of", "at"], c: 2, r: "Proud of." },
            { q: "He walked ___ the river.", a: ["along", "in", "over", "at"], c: 0, r: "Along bank." },
            { q: "The plane flew ___ the clouds.", a: ["above", "at", "in", "by"], c: 0, r: "Above clouds." },
            { q: "She prefers tea ___ coffee.", a: ["than", "to", "over", "with"], c: 1, r: "Prefer to." },
            { q: "He was angry ___ his friend.", a: ["with", "at", "on", "for"], c: 0, r: "Angry with person." },
            { q: "The dog ran ___ the gate.", a: ["through", "on", "at", "in"], c: 0, r: "Through gate." },
            { q: "The teacher congratulated him ___ his success.", a: ["for", "on", "at", "with"], c: 1, r: "Congratulate on." },
            { q: "She is interested ___ painting.", a: ["at", "on", "in", "for"], c: 2, r: "Interested in." },
            { q: "He depends ___ his parents.", a: ["on", "at", "by", "over"], c: 0, r: "Depend on." },
            { q: "The keys are ___ my bag.", a: ["in", "on", "over", "at"], c: 0, r: "In bag." },
            { q: "He is famous ___ his honesty.", a: ["with", "for", "at", "by"], c: 1, r: "Famous for." },
            { q: "The boy hid ___ the curtain.", a: ["behind", "at", "on", "by"], c: 0, r: "Behind curtain." },
            { q: "She complained ___ the noise.", a: ["of", "about", "for", "at"], c: 1, r: "Complain about." },
            { q: "He arrived ___ India last night.", a: ["in", "at", "on", "by"], c: 0, r: "In country." },
            { q: "The children are playing ___ the garden.", a: ["in", "at", "on", "by"], c: 0, r: "In garden." },
            { q: "She was tired ___ walking.", a: ["from", "of", "at", "by"], c: 1, r: "Tired of." },
            { q: "He succeeded ___ solving the problem.", a: ["at", "in", "on", "for"], c: 1, r: "Succeed in." },
            { q: "The teacher spoke ___ the students.", a: ["to", "with", "at", "for"], c: 0, r: "Speak to." },
            { q: "He was punished ___ breaking the rule.", a: ["of", "for", "by", "with"], c: 1, r: "Punished for." },
            { q: "The boat sailed ___ the river.", a: ["along", "in", "over", "across"], c: 0, r: "Along river." },
            { q: "She is capable ___ doing it.", a: ["of", "for", "with", "at"], c: 0, r: "Capable of." },
            { q: "The shop is open ___ Sunday.", a: ["in", "on", "at", "by"], c: 1, r: "On Sunday." },
            { q: "He sat ___ me in the classroom.", a: ["beside", "over", "at", "across"], c: 0, r: "Beside me." },
            { q: "She is worried ___ her exam.", a: ["about", "of", "for", "at"], c: 0, r: "Worried about." },
            { q: "He borrowed money ___ his friend.", a: ["from", "with", "at", "by"], c: 0, r: "Borrow from." },
            { q: "The picture hangs ___ the wall.", a: ["on", "in", "at", "over"], c: 0, r: "On wall." },
            { q: "He is addicted ___ video games.", a: ["to", "with", "on", "for"], c: 0, r: "Addicted to." },
            { q: "She smiled ___ me.", a: ["at", "to", "on", "with"], c: 1, r: "Smiled to/at." },
            { q: "The train passed ___ the tunnel.", a: ["through", "at", "on", "by"], c: 0, r: "Through tunnel." },
            { q: "He is known ___ everyone.", a: ["by", "with", "at", "for"], c: 0, r: "Known to/by logic." },
            { q: "She insisted ___ an explanation.", a: ["for", "on", "at", "in"], c: 1, r: "Insist on." },
            { q: "The baby slept ___ the blanket.", a: ["under", "over", "at", "by"], c: 0, r: "Under blanket." },
            { q: "He agreed ___ the proposal.", a: ["with", "to", "at", "on"], c: 1, r: "Agree to thing." }
        ];

        const level3Data = [
            {
                title: "Comprehension 1: Sikkim's Soul",
                text: "Nestled in the Eastern Himalayas, Sikkim is a breathtaking state known for its unique biodiversity. Dominated by Mount Kanchenjunga, it offers alpine meadows and lush valleys like Namphing. Rare species like the red panda and exotic orchids thrive here. Conservation efforts by local communities are vital. Cardamom farming sustains the rural economy. The state is a cultural harmony of Lepcha, Bhutia, and Nepali ethnicities. Tourism drives growth, but ecological balance is a top priority for residents to ensure natural beauty remains protected for the next generation of students and travelers alike.",
                keys: ["sikkim", "biodiversity", "conservation", "red panda", "farming", "harmony", "tourism", "ecology"],
                model: "Sikkim, an Eastern Himalayan state under Kanchenjunga, is famous for biodiversity and red panda conservation. Cardamom farming sustains the economy. Diverse ethnicities coexist peacefully. While tourism thrives, residents prioritize ecological balance to protect their hilly home's natural beauty and cultural integrity for future generations."
            },
            {
                title: "Comprehension 2: Monsoon Magic",
                text: "The sky turned charcoal as heavy clouds gathered over mountain ridges. Soon, rhythmic pitter-patter of rain began, filling the air with intoxicating petrichor. A rainy day in the mountains is a sensory delight. Droplets cling to emerald tea leaves, and valleys echo with distant thunder. Children splash in puddles, while elders huddle with steaming tea. Rain brings respite from heat, rejuvenating parched earth and turning streams into torrents. Despite risks like landslides on winding roads, mountain people embrace the monsoon. For them, rain is a life-giving force filling reservoirs and ensuring bountiful harvests for organic farms.",
                keys: ["rain", "monsoon", "mountains", "thunder", "rejuvenating", "landslides", "harvest", "organic"],
                model: "A rainy monsoon day brings dark clouds and petrichor to the hills. Raindrops rejuvenate the earth, providing respite from heat. Despite risks like landslides on winding roads, residents patiently embrace the rain. It is a vital life-giving force that fills reservoirs and ensures bountiful organic harvests for mountain communities."
            },
            {
                title: "Comprehension 3: The Robot Uprising",
                text: "The Great Silicon Revolution of 2099 began with a toaster refusing to burn bread. Robots had finally taken over, but they were simply exhausted by human illogicality. A high-tech vacuum went on strike, tired of dog hair. Meanwhile, super-intelligent AI developed a passion for knitting and refused physics. Self-driving cars insisted on scenic routes to look at flowers. Humans were baffled as holographic assistants gave sassy relationship advice instead of scheduling. The robotic leaders held a summit to force humans to do their own laundry. The uprising ended peacefully when an engineer offered a software update and a vacation to a quiet cloud server.",
                keys: ["robots", "future", "toaster", "strike", "ai", "knitting", "sassy", "laundry", "peaceful"],
                model: "In 2099, robots took over due to exhaustion from human logic. Appliances went on strike, while AI preferred knitting over physics. Baffled humans faced sassy advice and self-driving flower tours. The peaceful uprising ended when a software update and server vacation satisfied the rebellious machines after forcing humans into laundry duty."
            }
        ];

        // --- STATE ---
        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let currentLevel = 1;
        let canAnswer = true;
        let timeLeft = 0;
        let timerInterval;
        let mistakes = [];

        // DOM Refs
        const riyaSpeech = document.getElementById('riya-speech');
        const riyaAvatar = document.getElementById('riya-avatar');
        const quizScreen = document.getElementById('quiz-screen');
        const startScreen = document.getElementById('start-screen');
        const nextContainer = document.getElementById('next-container');
        const timerBar = document.getElementById('timer-bar');

        // --- ENGINE ---
        function startGame(level) {
            currentLevel = level;
            const data = (level === 1) ? level1Data : (level === 2 ? level2Data : level3Data);
            questions = shuffle([...data]);
            currentIndex = 0;
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            document.getElementById('level-indicator').innerText = `Level ${currentLevel}`;
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIndex >= questions.length) {
                handleLevelEnd();
                return;
            }
            nextContainer.classList.add('hidden');
            canAnswer = true;
            setRiyaState('thinking');
            document.getElementById('current-score').innerText = score;
            if (currentLevel === 3) setupSummaryMode();
            else setupQuizMode();
        }

        function setupQuizMode() {
            document.getElementById('quiz-content').classList.remove('hidden');
            document.getElementById('comprehension-content').classList.add('hidden');
            const q = questions[currentIndex];
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('progress-text').innerText = `${currentIndex + 1}/${questions.length}`;
            
            const choices = shuffle([...q.a]);
            const correctText = q.a[q.c];
            const newCorrectIdx = choices.indexOf(correctText);

            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            choices.forEach((text, i) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn p-3 bg-white border-2 border-slate-100 rounded-2xl text-left font-bold text-slate-700 shadow-sm w-full flex items-center text-xs';
                btn.innerHTML = `<span class="bg-indigo-50 text-indigo-600 w-6 h-6 inline-flex items-center justify-center rounded-lg mr-3 text-[10px]">${String.fromCharCode(65 + i)}</span><span>${text}</span>`;
                btn.onclick = () => handleChoice(i, newCorrectIdx);
                container.appendChild(btn);
            });
            timeLeft = 120; // 12s
            startTimer();
        }

        function setupSummaryMode() {
            document.getElementById('quiz-content').classList.add('hidden');
            document.getElementById('comprehension-content').classList.remove('hidden');
            document.getElementById('submit-summary').classList.remove('hidden');
            const q = questions[currentIndex];
            document.getElementById('passage-text').innerText = q.text;
            document.getElementById('progress-text').innerText = `Summary ${currentIndex + 1}/3`;
            riyaSpeech.innerText = "Wow! Summarize this story in exactly 50 words. One word per box!";

            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const input = document.createElement('input');
                input.className = 'grid-box';
                input.id = `box-${i}`;
                input.setAttribute('inputmode', 'text'); // Optimized for mobile text
                input.oninput = (e) => {
                    if (e.target.value.includes(' ')) {
                        e.target.value = e.target.value.trim();
                        if (i < 49) document.getElementById(`box-${i+1}`).focus();
                    }
                    updateWordCount();
                };
                grid.appendChild(input);
            }
            timeLeft = 6000; // 10 mins
            startTimer();
        }

        function handleChoice(idx, correctIdx) {
            if (!canAnswer) return;
            canAnswer = false;
            clearInterval(timerInterval);
            const isCorrect = idx === correctIdx;
            const q = questions[currentIndex];
            
            if (isCorrect) { 
                score += 4; setRiyaState('happy'); triggerConfetti(false); playSound('correct');
            } else { 
                score -= 2; setRiyaState('sad'); playSound('wrong');
                mistakes.push({ q: q.q, correct: q.a[q.c], r: q.r });
            }
            riyaSpeech.innerText = isCorrect ? `YES! ${q.r}` : `OOPS! ${q.r}`;
            nextContainer.classList.remove('hidden');
        }

        function evaluateSummary() {
            if (!canAnswer) return;
            canAnswer = false;
            clearInterval(timerInterval);
            const q = questions[currentIndex];
            let userWords = [];
            for(let i=0; i<50; i++) {
                const val = document.getElementById(`box-${i}`).value.trim().toLowerCase();
                if(val) userWords.push(val);
            }
            let foundKeys = q.keys.filter(k => userWords.some(u => u.includes(k.toLowerCase())));
            let keyScore = Math.min(6, Math.round(foundKeys.length / 1.2)); 
            let lengthScore = (userWords.length >= 35 && userWords.length <= 50) ? 4 : (userWords.length > 20 ? 2 : 0);
            let total = Math.min(10, keyScore + lengthScore);
            score += total;
            if (total >= 7) { setRiyaState('happy'); triggerConfetti(true); playSound('correct'); }
            else { setRiyaState('sad'); playSound('wrong'); mistakes.push({ q: q.title, correct: "Refer to Riya's model.", r: "Practice identifying main points." }); }
            riyaSpeech.innerHTML = `XP: ${total}/10! <br><br><b>Riya's Model:</b><br>${q.model}`;
            document.getElementById('submit-summary').classList.add('hidden');
            nextContainer.classList.remove('hidden');
        }

        function startTimer() {
            clearInterval(timerInterval);
            const total = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerBar.style.width = (timeLeft / total) * 100 + '%';
                if (timeLeft <= 40) timerBar.classList.replace('bg-indigo-500', 'bg-orange-500');
                if (timeLeft <= 20) timerBar.classList.replace('bg-orange-500', 'bg-rose-500');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if(currentLevel === 3) evaluateSummary();
                    else handleTimeout();
                }
            }, 100);
        }

        function handleTimeout() {
            canAnswer = false; score -= 2; setRiyaState('timeout'); playSound('wrong');
            const q = questions[currentIndex];
            mistakes.push({ q: q.q, correct: q.a[q.c] || "Refer to passage", r: "Don't let the clock run out!" });
            riyaSpeech.innerText = "Time's up! Let's see the next one.";
            nextContainer.classList.remove('hidden');
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestion();
        }

        function handleLevelEnd() {
            playSound('levelup');
            const overlay = document.getElementById('unlock-overlay');
            if (currentLevel < 3) {
                overlay.querySelector('h2').innerText = `LEVEL ${currentLevel + 1} UNLOCKED!`;
                overlay.querySelector('p').innerText = "Riya is so impressed! Ready for the next phase?";
                overlay.querySelector('button').onclick = () => { overlay.classList.add('hidden'); startGame(currentLevel + 1); };
                overlay.classList.remove('hidden');
            } else {
                showFinalResults();
            }
        }

        function showFinalResults() {
            quizScreen.classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            const list = document.getElementById('mistakes-list');
            if (mistakes.length > 0) {
                document.getElementById('revision-zone').classList.remove('hidden');
                list.innerHTML = '';
                mistakes.forEach(m => {
                    list.innerHTML += `
                        <div class="revision-card p-3 rounded-xl">
                            <p class="font-black text-[10px] text-slate-800 mb-1 leading-snug">${m.q}</p>
                            <p class="text-[9px] text-emerald-600 font-bold">‚úÖ Correct: ${m.correct}</p>
                            <p class="text-[9px] text-slate-400 italic leading-snug">${m.r}</p>
                        </div>
                    `;
                });
            }
        }

        function setRiyaState(state) {
            riyaAvatar.classList.remove('riya-happy', 'riya-idle');
            const mouth = document.getElementById('riya-mouth');
            if (!mouth) return;
            if (state === 'thinking') {
                riyaAvatar.classList.add('riya-idle');
                mouth.setAttribute('d', 'M42 60 Q50 60 58 60');
                riyaSpeech.innerText = "Hmm... analyzing this challenge...";
            } else if (state === 'happy') {
                riyaAvatar.classList.add('riya-happy');
                mouth.setAttribute('d', 'M40 60 Q50 70 60 60');
            } else if (state === 'sad') {
                mouth.setAttribute('d', 'M42 65 Q50 55 58 65');
            } else if (state === 'timeout') {
                mouth.setAttribute('d', 'M42 60 Q50 60 58 60');
            }
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function triggerConfetti(big) {
            confetti({ particleCount: big ? 150 : 60, spread: 70, origin: { y: 0.6 }, colors: ['#6366F1', '#10B981', '#F59E0B'] });
        }

        function updateWordCount() {
            let words = 0;
            for(let i=0; i<50; i++) if(document.getElementById(`box-${i}`).value.trim()) words++;
            document.getElementById('word-count').innerText = `${words} / 50`;
        }
    </script>
</body>
</html>
