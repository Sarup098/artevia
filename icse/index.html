<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICSE Grammar Hero: Master Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --error: #ef4444;
            --ice: #60a5fa;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: #f8fafc;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
        }

        .game-card {
            border-radius: 2rem;
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.2);
            transition: all 0.3s ease;
        }

        .wrong-mode { background-color: #ef4444 !important; }
        .wrong-mode #game-container { border-color: #b91c1c !important; background-color: #fee2e2 !important; animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .choice-btn {
            touch-action: manipulation;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom-width: 4px;
        }
        .choice-btn:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0px; }

        .riya-idle { animation: riya-wave 3s ease-in-out infinite; }
        .riya-happy { animation: riya-bounce 0.5s ease infinite; }
        @keyframes riya-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes riya-wave { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); } }

        .grid-box {
            width: 100%; aspect-ratio: 1/1; border: 1px solid #cbd5e1; text-align: center;
            font-size: 0.7rem; font-weight: 700; padding: 0; border-radius: 2px;
        }
        .grid-box:focus { background: #e0e7ff; outline: 2px solid #6366f1; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .frozen-timer { box-shadow: 0 0 15px var(--ice); background-color: var(--ice) !important; animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        @media (max-width: 640px) {
            .grid-box { height: 32px; font-size: 9px; }
            h1 { font-size: 1.875rem !important; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-3 sm:p-6">

    <div id="game-container" class="w-full max-w-xl bg-white game-card overflow-hidden border-4 border-white relative min-h-[90vh] flex flex-col transition-all duration-300">
        
        <!-- Start Screen -->
        <div id="start-screen" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
            <div class="p-4 bg-indigo-50 rounded-full border-4 border-white shadow-xl mb-6">
                <svg class="w-24 h-24" viewBox="0 0 100 100">
                    <circle cx="50" cy="45" r="35" fill="#FFD4B2" />
                    <path d="M15 45 Q15 10 50 10 Q85 10 85 45" fill="#4B2C20" />
                    <circle cx="35" cy="45" r="4" fill="#333" />
                    <circle cx="65" cy="45" r="4" fill="#333" />
                    <path d="M40 65 Q50 75 60 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round" />
                    <rect x="30" y="80" width="40" height="25" rx="10" fill="#6366F1" />
                </svg>
            </div>
            <h1 class="text-3xl font-black text-indigo-900 leading-none mb-2 tracking-tighter uppercase italic">GRAMMAR HERO</h1>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-8 text-center">Shree Raj Hostel Excellence</p>
            
            <div class="bg-indigo-50 p-6 rounded-[2rem] border-2 border-indigo-100 mb-8 w-full relative">
                <div class="absolute -top-3 -right-3 bg-rose-500 text-white text-[9px] font-black px-4 py-1 rounded-full shadow-lg rotate-12 uppercase">Target: 90+</div>
                <p class="text-indigo-900 font-bold italic mb-6 text-sm leading-relaxed text-center">
                    "Hi Bidur, Anuska, and Pravesh! Riya here! üåü Remember, score 90+ tomorrow! No negative marks. You have **7 Time Freezes** ‚ùÑÔ∏è to use whenever you want!"
                </p>
                <button onclick="startGame()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase tracking-widest text-sm">
                    START THE MASTER QUEST
                </button>
            </div>
        </div>

        <!-- Quest Interface -->
        <div id="quiz-screen" class="hidden flex-1 flex flex-col">
            <!-- HUD -->
            <div class="p-4 pb-2 flex justify-between items-center bg-white border-b border-slate-50">
                <div class="flex items-center space-x-2">
                    <div class="bg-slate-50 px-3 py-1 rounded-xl border border-slate-100 shadow-sm">
                        <span class="text-[7px] font-black text-slate-400 block uppercase">Total XP</span>
                        <span class="text-md font-black text-indigo-600" id="current-score">0</span>
                    </div>
                    <div class="bg-orange-50 px-3 py-1 rounded-xl border border-orange-100 shadow-sm">
                        <span class="text-[7px] font-black text-orange-400 block uppercase">Streak</span>
                        <span class="text-md font-black text-orange-600" id="current-streak">0</span>
                    </div>
                </div>
                <div class="text-right flex flex-col items-end">
                    <div id="bonus-badge" class="hidden bg-purple-100 text-purple-600 px-2 py-0.5 rounded-lg text-[7px] font-black uppercase animate-pulse mb-1 shadow-sm">2x XP ACTIVE</div>
                    <div id="progress-text" class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Step 1/53</div>
                </div>
            </div>

            <!-- Ability Bar -->
            <div id="ability-bar" class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex justify-center">
                <button id="freeze-btn" onclick="useFreeze()" class="flex items-center space-x-2 bg-white border-2 border-blue-100 px-4 py-1.5 rounded-2xl shadow-sm active:scale-95 transition-all">
                    <span class="text-sm">‚ùÑÔ∏è</span>
                    <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Freeze Time (<span id="freeze-count">7</span> left)</span>
                </button>
            </div>

            <div class="w-full h-1.5 bg-slate-100">
                <div id="timer-bar" class="h-full bg-indigo-500 transition-all duration-100" style="width: 100%"></div>
            </div>

            <div class="p-4 flex-1 flex flex-col">
                <div class="flex items-start space-x-3 mb-4">
                    <div id="riya-avatar-container" class="w-12 h-12 shrink-0 riya-idle">
                        <svg viewBox="0 0 100 100" id="riya-svg">
                            <circle cx="50" cy="45" r="35" fill="#FFD4B2" />
                            <path d="M15 45 Q15 10 50 10 Q85 10 85 45" fill="#4B2C20" />
                            <circle id="eye-l" cx="35" cy="45" r="3" fill="#333" />
                            <circle id="eye-r" cx="65" cy="45" r="3" fill="#333" />
                            <path id="riya-mouth" d="M42 60 Q50 65 58 60" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex-1">
                        <p id="riya-speech" class="text-[10px] font-bold text-indigo-900 leading-snug"></p>
                    </div>
                </div>

                <div id="quiz-content" class="flex-1 flex flex-col">
                    <div id="question-text" class="text-sm font-bold text-slate-800 mb-4 bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 leading-relaxed min-h-[4rem]"></div>
                    <div id="choices-container" class="grid grid-cols-1 gap-2"></div>
                </div>

                <div id="comprehension-content" class="hidden flex-1 flex flex-col">
                    <div class="max-h-40 overflow-y-auto mb-4 p-4 bg-slate-50 rounded-2xl border border-slate-200 text-[11px] leading-relaxed text-slate-600 font-medium" id="passage-text"></div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Summary Grid</span>
                            <span id="word-count" class="text-[9px] font-black text-indigo-600">0/50</span>
                        </div>
                        <div id="summary-grid" class="grid grid-cols-10 gap-0 border border-slate-300 rounded-sm overflow-hidden bg-white"></div>
                    </div>
                    <button id="submit-summary" onclick="evaluateSummary()" class="w-full bg-emerald-500 text-white font-black py-3 rounded-xl uppercase text-[10px] tracking-widest active:scale-95">Check My Work</button>
                </div>

                <div id="next-container" class="hidden mt-4">
                    <button id="next-btn" onclick="nextQuestion()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs flex items-center justify-center space-x-2">
                        <span>Continue Training</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden p-6 text-center overflow-y-auto flex-1 flex flex-col">
            <div class="text-5xl mb-4">üèÜ</div>
            <h2 class="text-2xl font-black text-indigo-900 mb-1 uppercase tracking-tighter leading-none">QUEST COMPLETE!</h2>
            <p class="text-slate-400 font-bold text-[9px] uppercase tracking-widest mb-6">Excellent Work, Bidur, Anuska, and Pravesh</p>
            
            <div class="bg-indigo-50 p-6 rounded-[2rem] mb-6 shadow-inner border border-indigo-100">
                <div class="text-6xl font-black text-indigo-600 mb-1" id="final-score">0</div>
                <div class="text-[9px] font-black text-indigo-400 uppercase">Total XP Earned</div>
            </div>

            <div id="revision-zone" class="hidden text-left space-y-3 mb-6">
                <h3 class="font-black text-slate-800 uppercase text-[10px] flex items-center mb-2"><span class="mr-2">üìö</span> THE MASTER REPORT</h3>
                <div id="mistakes-list" class="space-y-2"></div>
            </div>

            <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl uppercase text-xs mt-auto">Play Again</button>
        </div>
    </div>

    <script>
        // --- SOUND ENGINE ---
        let audioCtx;
        function playSfx(type) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'square'; osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'freeze') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        // --- MASTER DATASET (TRANSFERRED FROM USER LIST) ---
        const rawQuizPool = [
            // Section 1: Verbs
            { q: "We __________ (find) a dead mouse lying among our treasures.", a: ["find", "found", "finding", "had find"], c: 1, r: "Past tense narrative." },
            { q: "A boy took it up by its tail and __________ (wave) it in front of our faces.", a: ["waved", "wave", "waving", "was wave"], c: 0, r: "Sequential action in the past." },
            { q: "He __________ (hesitate) for a moment before throwing it.", a: ["hesitate", "hesitating", "hesitated", "had hesitate"], c: 2, r: "Simple past tense." },
            { q: "He __________ (select) clothes for me yesterday.", a: ["selects", "selected", "was select", "had select"], c: 1, r: "Yesterday indicates simple past." },
            { q: "My aunt __________ (give) my face a scrub.", a: ["give", "gave", "given", "giving"], c: 1, r: "Simple past." },
            { q: "My uncle followed me about __________ (utter) several pieces of advice.", a: ["utter", "uttered", "uttering", "was utter"], c: 2, r: "Present participle describing simultaneous action." },
            { q: "You must never scowl even if the sun __________ (hit) you in the eyes.", a: ["hit", "hits", "hitted", "hitting"], c: 1, r: "General truth/Conditional present." },
            { q: "In the morning, they __________ (think) of a plan.", a: ["think", "thought", "thinking", "had think"], c: 1, r: "Past tense." },
            { q: "They __________ (go) to the Dean and said they had a wedding.", a: ["go", "gone", "went", "going"], c: 2, r: "Simple past." },
            { q: "They agreed as they __________ (prepare) well.", a: ["prepared", "have prepared", "had prepared", "preparing"], c: 2, r: "Past Perfect for action completed before another past action." },
            
            // Section 2: Prepositions
            { q: "My best friend, John, is named __________ his grandfather.", a: ["with", "after", "to", "by"], c: 1, r: "Fixed phrase: Named after." },
            { q: "A grey mist hung __________ the fields.", a: ["above", "on", "over", "at"], c: 2, r: "Covering or suspended above: Over." },
            { q: "The little girl spoke __________ against the bully.", a: ["up", "out", "off", "for"], c: 0, r: "Speak up (increase courage/volume)." },
            { q: "They accused him __________ theft.", a: ["with", "on", "for", "of"], c: 3, r: "Fixed preposition: Accused of." },
            { q: "The police got the fire __________ control.", a: ["in", "under", "by", "with"], c: 1, r: "Fixed phrase: Under control." },
            { q: "There is a bridge __________ the river.", a: ["across", "over", "through", "on"], c: 0, r: "Spanning from side to side: Across." },
            { q: "The driver jumped __________ the car just in time.", a: ["off", "from", "out of", "away"], c: 2, r: "Exiting a 3D space: Out of." },
            { q: "I have not seen my uncle __________ last summer.", a: ["for", "since", "from", "during"], c: 1, r: "Point in time: Since." },
            { q: "There‚Äôs a black cat sitting __________ the wall.", a: ["in", "on", "at", "over"], c: 1, r: "On the surface." },
            { q: "The horse jumped __________ the hedge.", a: ["through", "under", "over", "by"], c: 2, r: "Leaping across the top: Over." },
            { q: "Mother goes __________ the market every day.", a: ["at", "to", "by", "for"], c: 1, r: "Direction to destination: To." },
            { q: "I often go to school __________ my friend.", a: ["by", "with", "along", "beside"], c: 1, r: "Company: With." },
            { q: "I have left my keys __________ home.", a: ["in", "to", "at", "by"], c: 2, r: "Location: At home." },
            { q: "A bird __________ hand is worth two in the bush.", a: ["on", "in", "at", "with"], c: 1, r: "Idiom: In hand." },
            { q: "The boy is crazy __________ football.", a: ["for", "with", "about", "in"], c: 2, r: "Idiomatic: Crazy about." },
            { q: "He opted __________ of the race.", a: ["off", "for", "out", "up"], c: 2, r: "Phrasal verb: Opt out of." },
            { q: "The police station is __________ the right.", a: ["at", "in", "on", "by"], c: 2, r: "Direction: On the right." },
            { q: "I looked at the stars __________ the telescope.", a: ["by", "in", "through", "with"], c: 2, r: "Viewing through a medium." },
            { q: "She was stung __________ a scorpion.", a: ["by", "from", "with", "of"], c: 0, r: "Passive agent: By." },
            { q: "Stop worrying __________ your future.", a: ["for", "of", "about", "on"], c: 2, r: "Worry about." },

            // Section 3: Synthesis
            { q: "These are fresh mangoes. I bought them yesterday.", a: ["These are fresh mangoes who I bought yesterday.", "These are fresh mangoes which I bought yesterday.", "These fresh mangoes were bought by me yesterday.", "I bought mangoes yesterday which are fresh."], c: 1, r: "Relative clause: which." },
            { q: "The debating teams were happy. They were declared joint champions.", a: ["The debating teams were happy as they had been declared joint champions.", "The debating teams were happy because they are declared joint champions.", "Being declared joint champions the debating teams are happy.", "The debating teams were happy despite being declared joint champions."], c: 0, r: "Reasoning with Past Perfect." },
            { q: "The teacher said, 'Come early tomorrow, the examination begins at eight o‚Äôclock.'", a: ["The teacher told us to come early the next day as the examination would begin at eight o'clock.", "The teacher told us to come early tomorrow as the examination begins at eight o'clock.", "The teacher told us to come early as the examination begins at eight tomorrow.", "The teacher told us that we should come early as the exam would begin at eight."], c: 0, r: "Indirect speech conversion." },
            { q: "Rahul not only plays the guitar but also the drums.", a: ["Rahul plays the guitar as well the drums.", "Rahul plays the guitar as well as the drums.", "Rahul plays guitar and drums as well.", "Rahul plays both guitar as well as drums."], c: 1, r: "Replacement using 'as well as'." },
            { q: "I prefer aerobics to yoga.", a: ["I would rather do aerobics to yoga.", "I would rather do aerobics than yoga.", "I would rather prefer aerobics than yoga.", "I would prefer rather aerobics than yoga."], c: 1, r: "Rather A than B." },
            { q: "No sooner did the film star arrive than the crowd cheered.", a: ["As soon as the film star arrived then the crowd cheered.", "As soon as the film star arrived the crowd cheered.", "As soon as the film star arrived, the crowd cheers.", "As soon as the film star arrives the crowd cheered."], c: 1, r: "As soon as pattern." },
            { q: "School bags are often too heavy for students to carry.", a: ["School bags are so heavy students cannot carry them.", "School bags are often so heavy that students cannot carry them.", "School bags are often so heavy for students to carry.", "School bags are heavy so students cannot carry them."], c: 1, r: "Too...to -> So...that logic." },
            { q: "The children have broken the window pane.", a: ["The window pane had been broken by the children.", "The window pane has been broken by the children.", "The window pane was broken by the children.", "The window pane has broken by the children."], c: 1, r: "Present Perfect Passive." },
            { q: "The apples are so cheap that they cannot be good.", a: ["The apples are too cheap and good.", "The apples are too good to be cheap.", "The apples are too cheap to be good.", "The apples are too cheap so they are not good."], c: 2, r: "So...that -> Too...to logic." },
            { q: "He asked, 'When do you intend to make the payment?'", a: ["He asked when he did intend to make the payment.", "He asked when I intended to make the payment.", "He asked when she is intending to make the payment.", "He asked when I would intend to make the payment."], c: 1, r: "Indirect question." },
            { q: "If the rain does not stop, Mariam will not be able to do the laundry.", a: ["Unless the rain does not stop, Mariam will not be able to do the laundry.", "Unless the rain stops, Mariam will not be able to do the laundry.", "Unless the rain stop, Mariam will not be able to do the laundry.", "Unless the rain stopped, Mariam will not be able to do the laundry."], c: 1, r: "Unless = If not." },
            { q: "This is the best movie I have ever seen.", a: ["Never I have seen a better movie than this.", "Never had I seen a better movie than this.", "Never have I seen a better movie than this.", "Never have I seen a movie good as this."], c: 2, r: "Never have I... inversion." },
            { q: "She is weak, but she is courageous.", a: ["Despite of being weak she is courageous.", "Despite being weak, she is courageous.", "Despite being courageous, she is not weak.", "Despite her weakness, but she is courageous."], c: 1, r: "Despite (no 'of')." },
            { q: "He is as wise as Solomon.", a: ["Solomon was wiser than he is.", "Solomon was not wiser than he is.", "He is not wiser than Solomon.", "Solomon is the wisest of all."], c: 2, r: "Negative comparison." },
            { q: "He jumped up. He ran away.", a: ["Jumping up, he ran away.", "He jumped up before he ran away.", "He ran away after jumping.", "He ran away because he jumped up."], c: 0, r: "Participle phrase." },
            { q: "Greenland is the largest island in the world.", a: ["Greenland is larger than any island in the world.", "Greenland is larger than any other island in the world.", "No other island is larger than Greenland.", "Greenland is the larger island in the world."], c: 1, r: "Superlative to Comparative." },
            { q: "He was so tired that he could not stand.", a: ["He was too tired and could not stand.", "He was too tired to stand.", "He was too tired that he could not stand.", "He was too tired so he could not stand."], c: 1, r: "Too...to rule." },
            { q: "'Can you help me to cross the street?' the old woman asked Arun.", a: ["The old woman asked Arun if he could help her to cross the street.", "The old woman asked Arun can you help me cross the street.", "The old woman asked Arun to help her cross the street.", "The old woman asked Arun if he can help her cross the street."], c: 0, r: "Indirect question logic." },
            { q: "As soon as the sun rose over the hills, the fog disappeared.", a: ["No sooner did the sun rose over the hills than the fog disappeared.", "No sooner did the sun rise over the hills than the fog disappeared.", "No sooner had the sun risen over the hills then the fog disappeared.", "No sooner the sun rose than the fog disappeared."], c: 1, r: "No sooner did...rise pattern." },
            { q: "Arun was asked by his mother to explain the missing buttons.", a: ["Arun's mother asked him for an explanation for the missing buttons.", "Arun gave an explanation to his mother for the missing buttons.", "Arun's mother asked for an explanation of the missing buttons.", "Arun's mother asked for an explanation of the missing buttons on his shirt."], c: 2, r: "Word form: explanation." }
        ];

        const summaryData = [
            {
                title: "Sikkim's Heritage",
                text: "Nestled in the Himalayas, Sikkim is a biodiversity gem. Mount Kanchenjunga provides a backdrop to lush valleys like Namphing. Nature sanctuary for red pandas. Conservation efforts are vital. Cardamom farming sustains the economy. Diverse ethnicities coexist in harmony. Residents prioritize ecological balance to protect natural beauty for future generations.",
                keys: ["sikkim", "biodiversity", "conservation", "red panda", "farming", "harmony", "ecology"],
                model: "Sikkim, under Kanchenjunga, is famous for biodiversity and red panda conservation. Cardamom farming sustains the economy while diverse ethnicities live peacefully. Residents prioritize ecological balance to protect their hilly home's natural beauty."
            },
            {
                title: "Monsoon Magic",
                text: "Dark clouds gather over mountain ridges. Rain fills the air with petrichor. Droplets cling to tea leaves. Valleys echo thunder. Children splash in puddles. Elders huddle with hot tea. Rain rejuvenates the earth. Despite landslides on winding roads, mountain people embrace the life-giving force filling reservoirs.",
                keys: ["rain", "monsoon", "petrichor", "rejuvenating", "landslides", "harvest"],
                model: "A rainy monsoon day brings dark clouds and petrichor to the hills. Raindrops rejuvenate the earth. Despite risks like landslides on winding roads, residents patiently embrace the rain. It is a vital life-giving force that fills reservoirs."
            },
            {
                title: "Silicon Uprising",
                text: "In 2099, a toaster refused to burn bread. Robots finally took over, exhausted by human illogicality. A high-tech vacuum cleaner went on strike. AI developed a passion for knitting. Self-driving cars took scenic flower routes. Assistants gave sassy relationship advice. The robotic leaders forced humans to do laundry. The uprising ended peacefully.",
                keys: ["robots", "future", "strike", "ai", "sassy", "laundry", "peaceful"],
                model: "In 2099, robots took over due to exhaustion from human logic. Appliances went on strike, while AI preferred knitting over physics. Baffled humans faced sassy advice and self-driving flower tours. The peaceful uprising ended when a software update satisfied the rebellious machines."
            }
        ];

        // --- STATE ---
        let currentQueue = [];
        let currentIndex = 0;
        let score = 0;
        let streak = 0;
        let summaryIndex = 0;
        let isSummaryMode = false;
        let canAnswer = true;
        let timeLeft = 0;
        let timerInterval;
        let mistakes = [];
        let autoDoubleActive = false;
        let isGracePeriod = false;
        let freezeCharges = 7;
        let isTimerFrozen = false;

        const getEl = (id) => document.getElementById(id);

        function startGame() {
            currentQueue = shuffle([...rawQuizPool]).map(q => ({...q, isRetry: false}));
            currentIndex = 0; score = 0; streak = 0; summaryIndex = 0; isSummaryMode = false; mistakes = []; freezeCharges = 7;
            getEl('start-screen').classList.add('hidden');
            getEl('quiz-screen').classList.remove('hidden');
            updateFreezeUI();
            loadQuestion();
        }

        function loadQuestion() {
            document.body.classList.remove('wrong-mode');
            const nextContainer = getEl('next-container');
            if (nextContainer) nextContainer.classList.add('hidden');
            canAnswer = true;
            isGracePeriod = false;
            isTimerFrozen = false;
            
            const bar = getEl('timer-bar');
            if(bar) {
                bar.classList.remove('frozen-timer', 'bg-rose-500');
                bar.classList.add('bg-indigo-500');
            }
            
            setRiyaState('thinking');
            
            if (getEl('current-score')) getEl('current-score').innerText = score;
            if (getEl('current-streak')) getEl('current-streak').innerText = streak;

            if (!isSummaryMode) {
                if (currentIndex >= currentQueue.length) { isSummaryMode = true; loadQuestion(); return; }
                setupQuizMode();
            } else {
                if (summaryIndex >= summaryData.length) { showFinalResults(); return; }
                setupSummaryMode();
            }
        }

        function setupQuizMode() {
            getEl('quiz-content').classList.remove('hidden');
            getEl('comprehension-content').classList.add('hidden');
            const q = currentQueue[currentIndex];
            getEl('question-text').innerText = q.q;
            getEl('progress-text').innerText = `Step ${currentIndex + 1}/${currentQueue.length}`;
            getEl('riya-speech').innerText = q.isRetry ? "Back for mastery! +1 XP." : "Focus on the logic, Bidur, Anuska, Pravesh!";
            
            const container = getEl('choices-container');
            container.innerHTML = '';
            shuffle([...q.a]).forEach((text, i) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn p-3 bg-white border-2 border-slate-100 rounded-2xl text-left font-bold text-slate-700 shadow-sm w-full flex items-center text-xs';
                btn.innerHTML = `<span class="bg-indigo-50 text-indigo-600 w-6 h-6 inline-flex items-center justify-center rounded-lg mr-3 text-[10px] shrink-0 font-black">${String.fromCharCode(65 + i)}</span><span>${text}</span>`;
                btn.onclick = () => handleChoice(text === q.a[q.c]);
                container.appendChild(btn);
            });
            timeLeft = 240;
            startTimer();
        }

        function handleChoice(isCorrect) {
            if (!canAnswer) return;
            canAnswer = false;
            clearInterval(timerInterval);
            const q = isSummaryMode ? summaryData[summaryIndex] : currentQueue[currentIndex];
            
            if (isCorrect) {
                let gain = 4;
                if (!isSummaryMode) {
                    if (q.isRetry) gain = 1;
                    else if (isGracePeriod || timeLeft <= 80) gain = 2; // Last 8s or Grace
                }

                if (autoDoubleActive) { gain *= 2; autoDoubleActive = false; getEl('bonus-badge').classList.add('hidden'); }
                
                score += gain; streak++;
                setRiyaState('happy'); playSfx('correct');
                getEl('riya-speech').innerText = `YES! +${gain} XP. ${!isSummaryMode ? q.r : ''}`;
                
                if (streak % 3 === 0) { 
                    autoDoubleActive = true; getEl('bonus-badge').classList.remove('hidden'); 
                    getEl('riya-speech').innerText += " (Streak of 3! Next = DOUBLE!)";
                    triggerConfetti(true); 
                } else triggerConfetti(false);
            } else {
                streak = 0; document.body.classList.add('wrong-mode');
                setRiyaState('sad'); playSfx('wrong');
                if (!isSummaryMode) {
                    getEl('riya-speech').innerText = `OOPS! Back to the queue. ${q.r}`;
                    mistakes.push({ q: q.q, correct: q.a[q.c] });
                    currentQueue.push({...q, isRetry: true});
                }
            }
            getEl('current-score').innerText = score;
            getEl('current-streak').innerText = streak;
            getEl('next-container').classList.remove('hidden');
        }

        function startTimer() {
            clearInterval(timerInterval);
            const total = isGracePeriod ? 50 : 240;
            timerInterval = setInterval(() => {
                if (isTimerFrozen) return;
                timeLeft--;
                const bar = getEl('timer-bar');
                if (bar) bar.style.width = (timeLeft / total) * 100 + '%';
                
                if (!isSummaryMode && !isGracePeriod && timeLeft === 80 && canAnswer) {
                    const q = currentQueue[currentIndex];
                    const buttons = getEl('choices-container').querySelectorAll('button');
                    let removed = 0;
                    buttons.forEach(btn => {
                        if (!btn.innerText.includes(q.a[q.c]) && removed < 2) {
                            btn.style.opacity = '0.2'; btn.disabled = true; removed++;
                        }
                    });
                    getEl('riya-speech').innerText = "8s left! I struck out two wrong answers!";
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (!isSummaryMode) {
                        if (!isGracePeriod) startGracePeriod();
                        else handleTimeout();
                    } else evaluateSummary();
                }
            }, 100);
        }

        function startGracePeriod() {
            isGracePeriod = true; timeLeft = 50;
            getEl('riya-speech').innerText = "‚è∞ TIME IS UP! Pick now! 5s left!";
            playSfx('wrong');
            getEl('timer-bar').classList.replace('bg-indigo-500', 'bg-rose-500');
            startTimer();
        }

        function handleTimeout() {
            canAnswer = false; streak = 0; document.body.classList.add('wrong-mode');
            setRiyaState('timeout'); playSfx('wrong');
            const q = currentQueue[currentIndex];
            currentQueue.push({...q, isRetry: true});
            getEl('riya-speech').innerText = "Time's up! Back in the queue.";
            getEl('current-streak').innerText = streak;
            getEl('next-container').classList.remove('hidden');
        }

        function useFreeze() {
            if (freezeCharges <= 0 || isTimerFrozen || !canAnswer || isSummaryMode) return;
            freezeCharges--; isTimerFrozen = true; clearInterval(timerInterval);
            updateFreezeUI(); playSfx('freeze');
            getEl('timer-bar').classList.add('frozen-timer');
            getEl('riya-speech').innerText = "‚ùÑÔ∏è TIME FROZEN! Take your time! ‚ùÑÔ∏è";
        }

        function updateFreezeUI() {
            getEl('freeze-count').innerText = freezeCharges;
            if (freezeCharges <= 0) getEl('freeze-btn').classList.add('opacity-50');
        }

        function setupSummaryMode() {
            getEl('quiz-content').classList.add('hidden');
            getEl('comprehension-content').classList.remove('hidden');
            getEl('submit-summary').classList.remove('hidden');
            getEl('freeze-btn').classList.add('hidden');
            const q = summaryData[summaryIndex];
            getEl('passage-text').innerText = q.text;
            getEl('progress-text').innerText = `Story ${summaryIndex + 1}/3`;
            getEl('riya-speech').innerText = "Summarize it in exactly 50 words.";

            const grid = getEl('summary-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const input = document.createElement('input');
                input.className = 'grid-box';
                input.id = `box-${i}`;
                input.setAttribute('inputmode', 'text');
                input.oninput = (e) => {
                    if (e.target.value.includes(' ')) {
                        e.target.value = e.target.value.trim();
                        if (i < 49) getEl(`box-${i+1}`).focus();
                    }
                    updateWordCount();
                };
                grid.appendChild(input);
            }
            timeLeft = 6000; startTimer();
        }

        function evaluateSummary() { handleChoice(true); getEl('riya-speech').innerHTML = `Summary XP earned! <br><br><b>Model:</b><br>${summaryData[summaryIndex].model}`; getEl('submit-summary').classList.add('hidden'); }
        function nextQuestion() { if (!isSummaryMode) currentIndex++; else summaryIndex++; loadQuestion(); }
        
        function showFinalResults() {
            getEl('quiz-screen').classList.add('hidden');
            getEl('result-screen').classList.remove('hidden');
            getEl('final-score').innerText = score;
            const list = getEl('mistakes-list');
            if (mistakes.length > 0) {
                getEl('revision-zone').classList.remove('hidden');
                list.innerHTML = '';
                mistakes.forEach(m => {
                    list.innerHTML += `<div class="p-2 border-b border-slate-100 text-[10px]"><p class="font-bold text-slate-800">${m.q}</p><p class="text-emerald-600 font-bold">‚úÖ Correct: ${m.correct}</p></div>`;
                });
            }
        }

        function setRiyaState(state) {
            const avatar = getEl('riya-avatar-container');
            const mouth = getEl('riya-mouth');
            const riyaAvatar = getEl('riya-avatar');
            if (!riyaAvatar || !mouth) return;
            riyaAvatar.classList.remove('riya-happy', 'riya-idle');
            if (state === 'thinking') { riyaAvatar.classList.add('riya-idle'); mouth.setAttribute('d', 'M42 60 Q50 60 58 60'); }
            else if (state === 'happy') { riyaAvatar.classList.add('riya-happy'); mouth.setAttribute('d', 'M40 60 Q50 70 60 60'); }
            else if (state === 'sad') mouth.setAttribute('d', 'M42 65 Q50 55 58 65');
            else if (state === 'timeout') mouth.setAttribute('d', 'M42 60 Q50 60 58 60');
        }

        function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
        function triggerConfetti(big) { confetti({ particleCount: big ? 150 : 60, spread: 70, origin: { y: 0.6 } }); }
        function updateWordCount() {
            let w = 0; for(let i=0; i<50; i++) if(getEl(`box-${i}`).value.trim()) w++;
            getEl('word-count').innerText = `${w} / 50`;
        }
    </script>
</body>
</html>
