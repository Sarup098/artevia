<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyCuepnUYt_rDEffSraYycHxYrm5sDlXM6s",
    authDomain: "palette-orders.firebaseapp.com",
    projectId: "palette-orders",
    storageBucket: "palette-orders.firebasestorage.app",
    messagingSenderId: "424044050877",
    appId: "1:424044050877:web:d58dcf37e9c01f36173ad4",
    measurementId: "G-72JP939JK2"
  };

  // Initialize Firebase
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- DOM Elements ---
  const formError = document.getElementById('form-error');
  const termsCheckbox = document.getElementById('terms-checkbox');
  const termsBox = document.getElementById('terms-box');
  const termsLabel = document.getElementById('terms-label');
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');
  const submitBriefBtn = document.getElementById('submit-brief-btn');
  const payButtonLink = document.getElementById('pay-button');
  const submitButtonText = document.getElementById('submit-button-text');
  const submitSpinner = document.getElementById('submit-spinner');
  const advanceDisplayPayment = document.getElementById('advance-display-payment');
  const fallbackContainer = document.getElementById('fallback-container');
  const whatsappFallbackBtn = document.getElementById('whatsapp-fallback-btn');

  // --- Navigation between steps ---
  window.goToStep = function(stepNum) {
    [step1, step2, step3].forEach(s => s.classList.add('hidden'));
    formError.textContent = '';

    if (stepNum === 1) step1.classList.remove('hidden');
    else if (stepNum === 2) {
      const name = document.getElementById('client-name').value.trim();
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();

      if (name && email && phone) step2.classList.remove('hidden');
      else {
        formError.textContent = 'Please fill in all contact details.';
        step1.classList.remove('hidden');
      }
    } else if (stepNum === 3) {
      step3.classList.remove('hidden');
      const advanceAmount = document.getElementById('advance-amount').value || "4000";
      advanceDisplayPayment.textContent = `₹${parseFloat(advanceAmount).toLocaleString('en-IN')}`;
    }
  };

  // --- Terms scroll enable ---
  window.checkScroll = function() {
    if (!termsBox) return;
    const isBottom = termsBox.scrollTop + termsBox.clientHeight >= termsBox.scrollHeight - 10;
    if (isBottom) {
      termsCheckbox.disabled = false;
      termsLabel.textContent = "I have read and agree to all the terms & conditions stated above.";
      termsLabel.classList.remove('text-gray-500');
    } else {
      termsCheckbox.disabled = true;
      termsLabel.textContent = "Please scroll to the bottom of the terms to agree.";
      termsLabel.classList.add('text-gray-500');
    }
  };

  window.toggleSubmitButton = function() {
    submitBriefBtn.disabled = !termsCheckbox.checked;
  };

  // --- Form Submission ---
  window.submitForm = async function(event) {
    event.preventDefault();
    formError.textContent = '';

    if (!termsCheckbox.checked) {
      formError.textContent = 'Please agree to the terms and conditions.';
      return;
    }

    // Loading state
    submitButtonText.textContent = 'Submitting...';
    submitSpinner.classList.remove('hidden');
    submitBriefBtn.disabled = true;

    const projectData = {
      clientName: document.getElementById('client-name').value.trim(),
      email: document.getElementById('client-email').value.trim(),
      phone: document.getElementById('client-phone').value.trim(),
      instagram: document.getElementById('client-ig').value || "N/A",
      idType: document.getElementById('id-type').value,
      idNumber: document.getElementById('id-number').value,
      projectTitle: document.getElementById('project-title').value,
      service: document.getElementById('service').value,
      agreedAmount: document.getElementById('agreed-amount').value,
      advanceAmount: document.getElementById('advance-amount').value,
      timeline: document.getElementById('timeline').value || "N/A",
      references: document.getElementById('references').value || "N/A",
      agreedToTerms: true,
      paymentStatus: "Pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      const docRef = await db.collection("clientProjects").add(projectData);
      console.log("✅ Saved with ID:", docRef.id);

      submitBriefBtn.classList.add('hidden');
      payButtonLink.classList.remove('hidden', 'opacity-50', 'cursor-not-allowed');
      payButtonLink.classList.add('bg-green-600', 'hover:bg-green-500');
      formError.textContent = '✅ Brief saved successfully! Please proceed to payment.';
      formError.style.color = '#4ade80';
    } catch (error) {
      console.error("❌ Firestore Error:", error);
      formError.textContent = 'Submission failed. Please use the WhatsApp fallback below.';

      const whatsappMessage = encodeURIComponent(
`*New Project Brief (Fallback)*

*Client:* ${projectData.clientName}
*Email:* ${projectData.email}
*Phone:* ${projectData.phone}
*Project:* ${projectData.projectTitle}
*Service:* ${projectData.service}
*Amount:* ₹${projectData.agreedAmount}
*Advance:* ₹${projectData.advanceAmount}
*Timeline:* ${projectData.timeline}

(Client agreed to terms)`
      );

      whatsappFallbackBtn.href = `https://wa.me/919907488075?text=${whatsappMessage}`;
      fallbackContainer.classList.remove('hidden');
    }

    // Reset button
    submitButtonText.textContent = 'Submit Brief';
    submitSpinner.classList.add('hidden');
  };

  // --- Admin redirect if needed ---
  if (window.location.hash === '#admin') window.location.href = 'admin.html';

  // Initial checks
  checkScroll();
  toggleSubmitButton();
</script>
